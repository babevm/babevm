<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Babe VM: src/c/zip.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Babe VM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('zip_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">zip.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="bvm_8h_source.html">../h/bvm.h</a>&quot;</code><br />
<code>#include &quot;../thirdparty/tinf-master/src/tinf.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct__jarstruct.html">_jarstruct</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ad068dd33774cc0d512d01dd20157005a"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#ad068dd33774cc0d512d01dd20157005a">READ_LE_INT</a>(b)&#160;&#160;&#160;((b)[0]|((b)[1]&lt;&lt;8)|((b)[2]&lt;&lt;16)|((b)[3]&lt;&lt;24))</td></tr>
<tr class="separator:ad068dd33774cc0d512d01dd20157005a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae6b333714cd785a5a3d5e84278f0bbe8"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#ae6b333714cd785a5a3d5e84278f0bbe8">READ_LE_SHORT</a>(b)&#160;&#160;&#160;((b)[0]|((b)[1]&lt;&lt;8))</td></tr>
<tr class="separator:ae6b333714cd785a5a3d5e84278f0bbe8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab1c1c150858ac9bb4bae7a65255184d0"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#ab1c1c150858ac9bb4bae7a65255184d0">MAX_JAR_SIZE</a>&#160;&#160;&#160;0xFFFFFF  /* 24 bits */</td></tr>
<tr class="separator:ab1c1c150858ac9bb4bae7a65255184d0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adf8304cea5e298a4415e45a7bff671f1"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#adf8304cea5e298a4415e45a7bff671f1">END_CEN_SIG</a>&#160;&#160;&#160;0x06054b50</td></tr>
<tr class="separator:adf8304cea5e298a4415e45a7bff671f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6524bff7aa9b04d73a25925ed7cd7465"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a6524bff7aa9b04d73a25925ed7cd7465">END_CEN_LEN</a>&#160;&#160;&#160;22</td></tr>
<tr class="separator:a6524bff7aa9b04d73a25925ed7cd7465"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acb0f7b90aaad08595213e44d2ed556ed"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#acb0f7b90aaad08595213e44d2ed556ed">END_CEN_ENTRIES_OFFSET</a>&#160;&#160;&#160;10</td></tr>
<tr class="separator:acb0f7b90aaad08595213e44d2ed556ed"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a962f9f51f067aa01066f50f108d25c8f"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a962f9f51f067aa01066f50f108d25c8f">END_CEN_DIR_SIZE_OFFSET</a>&#160;&#160;&#160;12</td></tr>
<tr class="separator:a962f9f51f067aa01066f50f108d25c8f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaa73a12a45c4d60d374779a703cdb290"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#aaa73a12a45c4d60d374779a703cdb290">END_CEN_DIR_START_OFFSET</a>&#160;&#160;&#160;16</td></tr>
<tr class="separator:aaa73a12a45c4d60d374779a703cdb290"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a259d478a34364b3eb6eb3a7c48324834"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a259d478a34364b3eb6eb3a7c48324834">CEN_FILE_HEADER_SIG</a>&#160;&#160;&#160;0x02014b50</td></tr>
<tr class="separator:a259d478a34364b3eb6eb3a7c48324834"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a69c8573f026d45f1ee4d79f2577d0cd8"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a69c8573f026d45f1ee4d79f2577d0cd8">CEN_FILE_HEADER_LEN</a>&#160;&#160;&#160;46</td></tr>
<tr class="separator:a69c8573f026d45f1ee4d79f2577d0cd8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aad91668bba9067b76a1bbf07da8dfff6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#aad91668bba9067b76a1bbf07da8dfff6">CEN_FILE_BITFLAG_OFFSET</a>&#160;&#160;&#160;8</td></tr>
<tr class="separator:aad91668bba9067b76a1bbf07da8dfff6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aede52d1b8f06ce594278e5f74fbe7fee"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#aede52d1b8f06ce594278e5f74fbe7fee">CEN_FILE_COMPMETH_OFFSET</a>&#160;&#160;&#160;10</td></tr>
<tr class="separator:aede52d1b8f06ce594278e5f74fbe7fee"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af9bb8c539c16cc3dfb178dc365f1972f"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#af9bb8c539c16cc3dfb178dc365f1972f">CEN_FILE_COMPLEN_OFFSET</a>&#160;&#160;&#160;20</td></tr>
<tr class="separator:af9bb8c539c16cc3dfb178dc365f1972f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6bc735ca7cb219f04972efd20ac1def7"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a6bc735ca7cb219f04972efd20ac1def7">CEN_FILE_UNCOMPLEN_OFFSET</a>&#160;&#160;&#160;24</td></tr>
<tr class="separator:a6bc735ca7cb219f04972efd20ac1def7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a13e94d7631c68e9d07a19a809ce61865"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a13e94d7631c68e9d07a19a809ce61865">CEN_FILE_PATHLEN_OFFSET</a>&#160;&#160;&#160;28</td></tr>
<tr class="separator:a13e94d7631c68e9d07a19a809ce61865"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a656d832f7d24501ae5ddad87201e4479"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a656d832f7d24501ae5ddad87201e4479">CEN_FILE_EXTRALEN_OFFSET</a>&#160;&#160;&#160;30</td></tr>
<tr class="separator:a656d832f7d24501ae5ddad87201e4479"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aecb3d7655e35c66923a57223b3362e96"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#aecb3d7655e35c66923a57223b3362e96">CEN_FILE_COMMENTLEN_OFFSET</a>&#160;&#160;&#160;32</td></tr>
<tr class="separator:aecb3d7655e35c66923a57223b3362e96"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7eae23e04af6cf6605a9154b32fb8eb4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a7eae23e04af6cf6605a9154b32fb8eb4">CEN_FILE_LOCALHDR_OFFSET</a>&#160;&#160;&#160;42</td></tr>
<tr class="separator:a7eae23e04af6cf6605a9154b32fb8eb4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd8b402ea38bcf6585a97017dfbf9722"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#acd8b402ea38bcf6585a97017dfbf9722">LOC_FILE_HEADER_SIG</a>&#160;&#160;&#160;0x04034b50</td></tr>
<tr class="separator:acd8b402ea38bcf6585a97017dfbf9722"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a12b66f2ac62f90a98216d1685af46b90"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a12b66f2ac62f90a98216d1685af46b90">LOC_FILE_HEADER_LEN</a>&#160;&#160;&#160;30</td></tr>
<tr class="separator:a12b66f2ac62f90a98216d1685af46b90"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a79652105c863d6f95dd6639424c13d5b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a79652105c863d6f95dd6639424c13d5b">LOC_FILE_BITFLAG_OFFSET</a>&#160;&#160;&#160;6</td></tr>
<tr class="separator:a79652105c863d6f95dd6639424c13d5b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a48b95c8478bf7a34df35ef6f5d4f3ce2"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a48b95c8478bf7a34df35ef6f5d4f3ce2">LOC_FILE_COMPLEN_OFFSET</a>&#160;&#160;&#160;18</td></tr>
<tr class="separator:a48b95c8478bf7a34df35ef6f5d4f3ce2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a28e6bbf2566b8597e63fa8ba5bb6d378"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a28e6bbf2566b8597e63fa8ba5bb6d378">LOC_FILE_UNCOMPLEN_OFFSET</a>&#160;&#160;&#160;22</td></tr>
<tr class="separator:a28e6bbf2566b8597e63fa8ba5bb6d378"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3e27c45526620031d055145532d84a20"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a3e27c45526620031d055145532d84a20">LOC_FILE_PATHLEN_OFFSET</a>&#160;&#160;&#160;26</td></tr>
<tr class="separator:a3e27c45526620031d055145532d84a20"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad3f1b8563b0789232ecf5abab2e1bfa2"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#ad3f1b8563b0789232ecf5abab2e1bfa2">LOC_FILE_EXTRA_OFFSET</a>&#160;&#160;&#160;28</td></tr>
<tr class="separator:ad3f1b8563b0789232ecf5abab2e1bfa2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad289a9013d2fd4d002612bac46359ed5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#ad289a9013d2fd4d002612bac46359ed5">COMP_STORED</a>&#160;&#160;&#160;0</td></tr>
<tr class="separator:ad289a9013d2fd4d002612bac46359ed5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a79a4c5260ad5eab87f4fd9c95be1b068"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a79a4c5260ad5eab87f4fd9c95be1b068">COMP_DEFLATED</a>&#160;&#160;&#160;8</td></tr>
<tr class="separator:a79a4c5260ad5eab87f4fd9c95be1b068"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a237e843557bcf70b6bc0f1d8c0a7dbcb"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct__jarstruct.html">_jarstruct</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a237e843557bcf70b6bc0f1d8c0a7dbcb">jardesc_t</a></td></tr>
<tr class="separator:a237e843557bcf70b6bc0f1d8c0a7dbcb"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:acaa31758ede9a725dcaaf79af63ef57c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="file_8h.html#aea1aa8198cdc8d0fa40a3e046c21b555">bvm_filebuffer_t</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#acaa31758ede9a725dcaaf79af63ef57c">bvm_zip_buffer_file_from_jar</a> (char *jarname, char *pathname)</td></tr>
<tr class="separator:acaa31758ede9a725dcaaf79af63ef57c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ace6d5b9f43712e91986554e3297077d6"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#ace6d5b9f43712e91986554e3297077d6">jars_sz</a> = 10</td></tr>
<tr class="separator:ace6d5b9f43712e91986554e3297077d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a673a2f993fc6e9afe690af4afa980bc8"><td class="memItemLeft" align="right" valign="top"><a class="el" href="zip_8c.html#a237e843557bcf70b6bc0f1d8c0a7dbcb">jardesc_t</a> **&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="zip_8c.html#a673a2f993fc6e9afe690af4afa980bc8">jars</a> = NULL</td></tr>
<tr class="separator:a673a2f993fc6e9afe690af4afa980bc8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Jar file handling and functions</p>
<dl class="section author"><dt>Author</dt><dd>Greg McCreath </dd></dl>
<dl class="section since"><dt>Since</dt><dd>0.0.10</dd></dl>
<h1><a class="anchor" id="jarov"></a>
Overview</h1>
<p>This unit provides functionality for the platform to read and understand jar (zip) files. This is a basic jar reader and not a winzip equivalent.</p>
<p>Each jar file opened is 'interned' and it not closed during the executing of the VM. A jar is opened and kept open. Open jars are held in an array of descriptors (<a class="el" href="zip_8c.html#a673a2f993fc6e9afe690af4afa980bc8">jars</a>) defined in this unit. Rather than create another pool, like that used for classes or interned string this is simple and self contained here.</p>
<h1><a class="anchor" id="jar101"></a>
Jar Files 101</h1>
<p>A Java jar file is actually a renamed zip file. They are equivalent. The zip specification can be read here:</p>
<p><a href="http://www.pkware.com/documents/casestudies/APPNOTE.TXT">http://www.pkware.com/documents/casestudies/APPNOTE.TXT</a></p>
<p>It is very important to read that specification if you are attempting to understand this unit.</p>
<p>Weirdly, a zip file has the files contained in it listed twice. No doubt due to legacy. The first list starts at the beginning of the file and proceeds as:</p>
<p>[fileheader][filedata][fileheader][filedata] ... etc</p>
<p>this list is referred as 'local' (for some reason). The file headers in this list are referred to as 'local' headers and each header has a standard 4 byte signature that lets you know you are reading a local file header.</p>
<p>The other list is contained in what is called the Central Directory (CD). This list is located at/near the end of the file. A end-of-central-directory record is the first thing to be read, it gives the offset of the start of the CD. The start of the CD represents the start of a list of file headers rather like the local file headers, except these are called 'central directory file headers'. They contain some duplicated information from the local file headers. Depending on a bit flag, some info may exist in either the local file header or the central file header. Great. Thanks.</p>
<p>The key difference of entries in the central directory is that they are not followed by file data. Each central directory file header contains an offset to the local file header (which <em>is</em> followed by the data). To get at the actual file data the local header can be located using the offset described in the central directory header.</p>
<p>All integer values stored in a jar file are in little-endian format. That explains the usage of the <a class="el" href="zip_8c.html#ad068dd33774cc0d512d01dd20157005a">READ_LE_INT</a> and <a class="el" href="zip_8c.html#ae6b333714cd785a5a3d5e84278f0bbe8">READ_LE_SHORT</a> macros defined below to read those little endian values into int/short in an endian independent manner.</p>
<h1><a class="anchor" id="intern"></a>
Jar Interning</h1>
<p>Jars are interned to make accessing them faster. The jar format offers no optimised means of locating an entry in the jar file. Worst case is a linear lookup through the jar file looking at directory entries one at a time until the correct one is found. Nasty.</p>
<p>Of course, a linear lookup like the one described above is memory efficient but certainly not fast. The fastest way to access a jar file would be to keep it all in memory and deal with it there (some VM implementations do just this). A less extreme way may be to cache just the directory information from the jar in memory and use that to speed up access to the actual file. Trouble is, directories in jar files can be large. Each directory entry (local+central) carries about 80 bytes of overhead - excluding the actual file and path name. So a 100 file jar would take at least 8k of memory to cache the directory (plus the actual file names themselves - so it is more likely to be something like 10-12k). Too much.</p>
<p>(side note: memory requirement could be reduced to probably about 30 bytes + the file name size for each entry, but that is still quite a lot).</p>
<p>Keeping some directory information cached is going to speed up access to the jar file entry a lot so a better scheme is required.</p>
<p>The approach we have taken here is to cache <em>some</em> of the directory. And then, only enough to identify a possible file match and where to look next. The cache method we use here takes 4 bytes per jar file entry. That 100 file jar then has 400 bytes of overhead for caching and not 12k.</p>
<p>How is it done? When a jar is opened it is 'interned'. The intern processing creates the descriptor for it and then scans the jar central directory. For each file header in the central directory a hash is calculated on the file name (and full path), and along with the offset to that directory file header is stored with the jar descriptor.</p>
<p>These two values are squeezed into a 4 byte int. The top 3 bytes have the offset, the lower byte has the hash of the file name (mod 255 - to get a value between 0 and 255, so it goes into one byte).</p>
<p>The interned jar descriptor then has an cache (array) of 4 byte values that represent the hash of the file name and where to find its central directory file header in the jar.</p>
<p>When getting a file from the jar, a hash (mod 255) on the requested file name is calculated and then the cache is scanned looking for jar file entries with a matching hash. When one is found, the central directory file header is read from the jar file by using the offset contained in the top 3 bytes of the jar desc cache entry. If the file name at the given record matches, we have the file. If not, keep scanning the jar desc cache looking for the next file with the same hash to test it also.</p>
<p>Yes, it is true, this does mean that there may be collisions and the actual jar file central directory may have to be read more than once to get to the real file, but it a pretty good trade off. With a hash range of 255 there will (hopefully) rarely be collisions and even more rarely will there be a double collision. At any rate, I think it is a good compromise between memory usage and speed.</p>
<p>Using 3 bytes for the offset does mean a max offset of 2^24 (16M). This in practice means that jar files must be less than than 16M. For this VM, I am sure that will not be an issue.</p>
<h1><a class="anchor" id="note"></a>
Note</h1>
<p>During interning the full central directory of the jar is loaded into memory. The central directory overhead is about 50 bytes per file. So using the 100 file example before, this would mean about 7-8k of heap is used temporarily during interning. It is freed immediately after interning.</p>
<p>The array used for interned jar files is allocated from the heap and grows automatically as required. It never shrinks.</p>
<p>At this point the scan through an interned jar file desc file entry cache is linear.</p>
<h1><a class="anchor" id="nsupp"></a>
Not Supported ...</h1>
<p>Some things to note (like .. what is not known to be supported):</p>
<ul>
<li>The ZIP64 format is not supported. Only 32 bit zips are supported. </li>
<li>Comments on a jar file are not supported. In fact, they will cause the file not be read. Why? The comments are variable length and on the end of the file, so supporting them means scanning backwards from the end of the file to find the end-of-central-directory record. Can't be bothered and there is already a fair bit of code here - so comments on a jar file will cause failure. Don't comment jar files. </li>
<li>full file names (including the directory path) cannot be longer than 255. </li>
<li>a jar file cannot be greater than 16777215k (16M) in size. </li>
<li>split jar files are not supported. Yes, the zip spec says you can split them. We don't. </li>
<li>only the DEFLATE and STORE compression methods are supported. </li>
<li>crc32 checksums are not being checked as the file is inflated. </li>
</ul>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="aad91668bba9067b76a1bbf07da8dfff6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aad91668bba9067b76a1bbf07da8dfff6">&#9670;&nbsp;</a></span>CEN_FILE_BITFLAG_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_BITFLAG_OFFSET&#160;&#160;&#160;8</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aecb3d7655e35c66923a57223b3362e96"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aecb3d7655e35c66923a57223b3362e96">&#9670;&nbsp;</a></span>CEN_FILE_COMMENTLEN_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_COMMENTLEN_OFFSET&#160;&#160;&#160;32</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="af9bb8c539c16cc3dfb178dc365f1972f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af9bb8c539c16cc3dfb178dc365f1972f">&#9670;&nbsp;</a></span>CEN_FILE_COMPLEN_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_COMPLEN_OFFSET&#160;&#160;&#160;20</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aede52d1b8f06ce594278e5f74fbe7fee"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aede52d1b8f06ce594278e5f74fbe7fee">&#9670;&nbsp;</a></span>CEN_FILE_COMPMETH_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_COMPMETH_OFFSET&#160;&#160;&#160;10</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a656d832f7d24501ae5ddad87201e4479"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a656d832f7d24501ae5ddad87201e4479">&#9670;&nbsp;</a></span>CEN_FILE_EXTRALEN_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_EXTRALEN_OFFSET&#160;&#160;&#160;30</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a69c8573f026d45f1ee4d79f2577d0cd8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a69c8573f026d45f1ee4d79f2577d0cd8">&#9670;&nbsp;</a></span>CEN_FILE_HEADER_LEN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_HEADER_LEN&#160;&#160;&#160;46</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a259d478a34364b3eb6eb3a7c48324834"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a259d478a34364b3eb6eb3a7c48324834">&#9670;&nbsp;</a></span>CEN_FILE_HEADER_SIG</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_HEADER_SIG&#160;&#160;&#160;0x02014b50</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a7eae23e04af6cf6605a9154b32fb8eb4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7eae23e04af6cf6605a9154b32fb8eb4">&#9670;&nbsp;</a></span>CEN_FILE_LOCALHDR_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_LOCALHDR_OFFSET&#160;&#160;&#160;42</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a13e94d7631c68e9d07a19a809ce61865"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a13e94d7631c68e9d07a19a809ce61865">&#9670;&nbsp;</a></span>CEN_FILE_PATHLEN_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_PATHLEN_OFFSET&#160;&#160;&#160;28</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a6bc735ca7cb219f04972efd20ac1def7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6bc735ca7cb219f04972efd20ac1def7">&#9670;&nbsp;</a></span>CEN_FILE_UNCOMPLEN_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CEN_FILE_UNCOMPLEN_OFFSET&#160;&#160;&#160;24</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a79a4c5260ad5eab87f4fd9c95be1b068"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a79a4c5260ad5eab87f4fd9c95be1b068">&#9670;&nbsp;</a></span>COMP_DEFLATED</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define COMP_DEFLATED&#160;&#160;&#160;8</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ad289a9013d2fd4d002612bac46359ed5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad289a9013d2fd4d002612bac46359ed5">&#9670;&nbsp;</a></span>COMP_STORED</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define COMP_STORED&#160;&#160;&#160;0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a962f9f51f067aa01066f50f108d25c8f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a962f9f51f067aa01066f50f108d25c8f">&#9670;&nbsp;</a></span>END_CEN_DIR_SIZE_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define END_CEN_DIR_SIZE_OFFSET&#160;&#160;&#160;12</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aaa73a12a45c4d60d374779a703cdb290"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaa73a12a45c4d60d374779a703cdb290">&#9670;&nbsp;</a></span>END_CEN_DIR_START_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define END_CEN_DIR_START_OFFSET&#160;&#160;&#160;16</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="acb0f7b90aaad08595213e44d2ed556ed"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acb0f7b90aaad08595213e44d2ed556ed">&#9670;&nbsp;</a></span>END_CEN_ENTRIES_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define END_CEN_ENTRIES_OFFSET&#160;&#160;&#160;10</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a6524bff7aa9b04d73a25925ed7cd7465"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6524bff7aa9b04d73a25925ed7cd7465">&#9670;&nbsp;</a></span>END_CEN_LEN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define END_CEN_LEN&#160;&#160;&#160;22</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="adf8304cea5e298a4415e45a7bff671f1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adf8304cea5e298a4415e45a7bff671f1">&#9670;&nbsp;</a></span>END_CEN_SIG</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define END_CEN_SIG&#160;&#160;&#160;0x06054b50</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a79652105c863d6f95dd6639424c13d5b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a79652105c863d6f95dd6639424c13d5b">&#9670;&nbsp;</a></span>LOC_FILE_BITFLAG_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOC_FILE_BITFLAG_OFFSET&#160;&#160;&#160;6</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a48b95c8478bf7a34df35ef6f5d4f3ce2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a48b95c8478bf7a34df35ef6f5d4f3ce2">&#9670;&nbsp;</a></span>LOC_FILE_COMPLEN_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOC_FILE_COMPLEN_OFFSET&#160;&#160;&#160;18</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ad3f1b8563b0789232ecf5abab2e1bfa2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad3f1b8563b0789232ecf5abab2e1bfa2">&#9670;&nbsp;</a></span>LOC_FILE_EXTRA_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOC_FILE_EXTRA_OFFSET&#160;&#160;&#160;28</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a12b66f2ac62f90a98216d1685af46b90"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a12b66f2ac62f90a98216d1685af46b90">&#9670;&nbsp;</a></span>LOC_FILE_HEADER_LEN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOC_FILE_HEADER_LEN&#160;&#160;&#160;30</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="acd8b402ea38bcf6585a97017dfbf9722"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd8b402ea38bcf6585a97017dfbf9722">&#9670;&nbsp;</a></span>LOC_FILE_HEADER_SIG</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOC_FILE_HEADER_SIG&#160;&#160;&#160;0x04034b50</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a3e27c45526620031d055145532d84a20"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3e27c45526620031d055145532d84a20">&#9670;&nbsp;</a></span>LOC_FILE_PATHLEN_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOC_FILE_PATHLEN_OFFSET&#160;&#160;&#160;26</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a28e6bbf2566b8597e63fa8ba5bb6d378"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a28e6bbf2566b8597e63fa8ba5bb6d378">&#9670;&nbsp;</a></span>LOC_FILE_UNCOMPLEN_OFFSET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOC_FILE_UNCOMPLEN_OFFSET&#160;&#160;&#160;22</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ab1c1c150858ac9bb4bae7a65255184d0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab1c1c150858ac9bb4bae7a65255184d0">&#9670;&nbsp;</a></span>MAX_JAR_SIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_JAR_SIZE&#160;&#160;&#160;0xFFFFFF  /* 24 bits */</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ad068dd33774cc0d512d01dd20157005a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad068dd33774cc0d512d01dd20157005a">&#9670;&nbsp;</a></span>READ_LE_INT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define READ_LE_INT</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">b</td><td>)</td>
          <td>&#160;&#160;&#160;((b)[0]|((b)[1]&lt;&lt;8)|((b)[2]&lt;&lt;16)|((b)[3]&lt;&lt;24))</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Read a non-aligned little-endian 4 byte value </p>

</div>
</div>
<a id="ae6b333714cd785a5a3d5e84278f0bbe8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae6b333714cd785a5a3d5e84278f0bbe8">&#9670;&nbsp;</a></span>READ_LE_SHORT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define READ_LE_SHORT</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">b</td><td>)</td>
          <td>&#160;&#160;&#160;((b)[0]|((b)[1]&lt;&lt;8))</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Read a non-aligned little-endian 2 byte value </p>

</div>
</div>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="a237e843557bcf70b6bc0f1d8c0a7dbcb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a237e843557bcf70b6bc0f1d8c0a7dbcb">&#9670;&nbsp;</a></span>jardesc_t</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct__jarstruct.html">_jarstruct</a> <a class="el" href="zip_8c.html#a237e843557bcf70b6bc0f1d8c0a7dbcb">jardesc_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>A cached descriptor of an already-opened jar file. The jar descriptor is used to cache some important information extracted from the jar file to make searching it faster. </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="acaa31758ede9a725dcaaf79af63ef57c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acaa31758ede9a725dcaaf79af63ef57c">&#9670;&nbsp;</a></span>bvm_zip_buffer_file_from_jar()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="file_8h.html#aea1aa8198cdc8d0fa40a3e046c21b555">bvm_filebuffer_t</a>* bvm_zip_buffer_file_from_jar </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>jarname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>pathname</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Load a given file name in a jar into an <a class="el" href="file_8h.html#aea1aa8198cdc8d0fa40a3e046c21b555">bvm_filebuffer_t</a>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">jarname</td><td>the name of the jar file </td></tr>
    <tr><td class="paramname">pathname</td><td>the path of the file in the jar to load</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>a handle to file buffer <a class="el" href="file_8h.html#aea1aa8198cdc8d0fa40a3e046c21b555">bvm_filebuffer_t</a>. </dd></dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a673a2f993fc6e9afe690af4afa980bc8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a673a2f993fc6e9afe690af4afa980bc8">&#9670;&nbsp;</a></span>jars</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="zip_8c.html#a237e843557bcf70b6bc0f1d8c0a7dbcb">jardesc_t</a>** jars = NULL</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>array of pointers to jar descriptors </p>

</div>
</div>
<a id="ace6d5b9f43712e91986554e3297077d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ace6d5b9f43712e91986554e3297077d6">&#9670;&nbsp;</a></span>jars_sz</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int jars_sz = 10</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>initial size of jar descriptors array </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_3b19ecf29356981f494745fbef7e56bf.html">c</a></li><li class="navelem"><a class="el" href="zip_8c.html">zip.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
