<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Babe VM: src/c/exec.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Babe VM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('exec_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">exec.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="bvm_8h_source.html">../h/bvm.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a7909a2800d60d4f8ffcddd2923b02c40"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="exec_8c.html#a7909a2800d60d4f8ffcddd2923b02c40">CURRENT_OPCODE</a>&#160;&#160;&#160;(opcode)</td></tr>
<tr class="separator:a7909a2800d60d4f8ffcddd2923b02c40"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9b71a6eefca1e6c832580bb2d9a9e1cd"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="exec_8c.html#a9b71a6eefca1e6c832580bb2d9a9e1cd">OPCODE_DISPATCH</a>(i)&#160;&#160;&#160;switch(i) {</td></tr>
<tr class="separator:a9b71a6eefca1e6c832580bb2d9a9e1cd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a432e10874d63407a7951d93c57182873"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="exec_8c.html#a432e10874d63407a7951d93c57182873">OPCODE_HANDLER</a>(n)&#160;&#160;&#160;case (n)</td></tr>
<tr class="separator:a432e10874d63407a7951d93c57182873"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a275af78a484f8d9913fd113fb4f64966"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="exec_8c.html#a275af78a484f8d9913fd113fb4f64966">OPCODE_NEXT</a>&#160;&#160;&#160;break;</td></tr>
<tr class="separator:a275af78a484f8d9913fd113fb4f64966"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ace6a4a30c3f778ce0b51eb2866230192"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="exec_8c.html#ace6a4a30c3f778ce0b51eb2866230192">OPCODE_DISPATCH_END</a>&#160;&#160;&#160;}</td></tr>
<tr class="separator:ace6a4a30c3f778ce0b51eb2866230192"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a75bdaa7be503f9dbdf92f6cb4f5407fd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="exec_8c.html#a75bdaa7be503f9dbdf92f6cb4f5407fd">bvm_exec_run</a> ()</td></tr>
<tr class="separator:a75bdaa7be503f9dbdf92f6cb4f5407fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>The Interpreter Loop</p>
<h1><a class="anchor" id="exec-ov"></a>
Overview</h1>
<p>The big loop. You've finally found the meat of it all. Yes, this is big. The interpreter loop is a classic large switch statement.</p>
<p>The case statements are in order from 0 and are padded to 255 (in the hope that this helps the compiler).</p>
<p>The VM runs only this one loop - #run_virtual_machine() is called at VM startup and exits when all non-daemon threads are terminated. It is not reentrant. The VM spins on a loop within #run_virtual_machine(). Starting with the bootstrap thread at VM startup, each thread gets execution time in this loop. When a thread context switch is made, the current thread's 'registers' are saved to the thread struct, and the new thread's registers are restored to the 'global registers'. See the doc in #frame.c for a better discussion on 'registers'.</p>
<p>Every opcode is dealt with here within the <a class="el" href="exec_8c.html#a75bdaa7be503f9dbdf92f6cb4f5407fd">bvm_exec_run()</a> loop. Some documentation is provided within them, but often they are small and mostly self-explanatory after having read the JVM specs. Yes, you will need to be <em>very</em> familiar with the JVM specifications to get all this.</p>
<p>You will see some 'goto' statements and labels used in this main loop. They are used carefully and sparingly but with purpose. "Rules are for the obedience of fools and the guidance of wise men". Nuff said.</p>
<h1><a class="anchor" id="exec-exception"></a>
Exception Handling</h1>
<p>The VM needs to cater for two types of exception: those thrown by the VM, and those thrown by the java bytecode. The handling of each is almost identical. The code in the <code>athrow</code> opcode handles both.</p>
<p>The VM distinguishes whether an exception is native by the <code>needs_native_try_reset</code> field on an exception. This is true if the VM was the source of the exception and false if the bytecode was the source.</p>
<p>The primary difference between native and bytecode exception handling is what to do <em>after</em> an exception has been caught by a catch() java statement. Native exceptions return to the 'new_try_block' label so that the VM can reset all stuff ready to catch another native exception. The bytecode exceptions return to the 'exception_is_handled' label ready to do the next opcode. That is why you'll notice that the entire exec loop is surrounded by a BVM_TRY/BVM_CATCH block. When a native exception is caught by this block, control passes to the same code (in <code>OPCODE_athrow</code>) that handles normal bytecode exceptions - but after handling the native exception, control passes to above the <code>BVM_TRY</code> to reenter it.</p>
<p>The VM supports the Java 5 <code>uncaughtExceptionHandler</code> mechanism for threads. Control will be passed to a thread's default exception handler if an exception is not caught for that thread.</p>
<p>Locating an exception's handler (try/catch/finally block) and actually moving to that location in the stack are separated into two distinct 'exception handling' steps. This is done for debugger support.</p>
<p>For reporting of exceptions, the debugger wants to know all details of the exception, including where it is caught (if it is indeed, caught) <em>before</em> the stack is altered. So, actually gathering all info about the exception is the first step. This may be delivered to a debugger, and the thread suspended, so the handling of the second step is quite distinct. To this end a new Babe-VM specific opcode <code>'OPCODE_pop_to_exception'</code> has been introduced that performs the second part of exception handling: that is altering the stack state to point to the exception handler location (or, if the exception is uncaught, to pop everything off the stack).</p>
<p>Nothing is pushed onto the stack for the OPCODE_pop_to_exception to work with. All the info about an exception and its handler locations is held in the current thread in the <a class="el" href="structbvm__find__exception__callback__data.html">bvm_find_exception_callback_data</a> <code>exception_location</code> struct.</p>
<h1><a class="anchor" id="exec-fastbytecode"></a>
Fast Bytecode Substitution</h1>
<p>Some non-Java (Babe VM specific) opcodes have been used to help speed up some things. These new opcode names end with '_fast'. Quite simply, they are some faster versions of standard opcodes. For example, all the field get/put opcodes have fast equivalents. Why? The first time a constant is used to reference a field a pointer to that field is stored in the constant. So the next time the same bytecode is executed we know there will be a faster way to get at the field. Rather than re-resolving the constant pool field, we can just get it straight from the constant as a pointer. Rather than test this every time (is the field resolved or not?) we'll just point the opcode to another place so the next time (say) <code>OPCODE_getfield</code> is not executed, but <code>OPCODE_getfield_fast</code> is instead. <code>OPCODE_getfield_fast</code> gets the pointer from the constant and uses it. Much faster. Additionally, some checks that the VM may perform first time around are unnecessary the second time. Why check again if the class is initialised? We know it must be because we did it the first time.</p>
<p>Note that the benefits of the fast opcodes are only realised if the code is executed more than once. It does not mean that every (say) opcode <code>OPCODE_getfield</code> will now use <code>OPCODE_getfield_fast</code>. The opcode substitution is only performed to a particular opcode in a particular method in a particular class.</p>
<p>Fast bytecode substitution is disabled if the <a class="el" href="define_8h.html#aad853eeb19817dd53916a15fba967353">BVM_DEBUGGER_ENABLE</a> compile-time option is enabled. During debugging, the OPCODE_BREAKPOINT bytecode substitution takes place to facilitate debugger breakpoints.</p>
<h1><a class="anchor" id="exec-registers"></a>
Using Registers</h1>
<p>Some platforms may operate faster if the VM registers can be stored in CPU registers and used from there. This can only happen with local variables and not with global ones. So, some compile time options are implemented that will use (or not) the VM registers as local variables. In order to use the registers as local variables, whenever a function call is made from the interp loop that uses and/or changes the global registers, the local ones will need to be copied to global before the function call and restored from the globals afterwards.</p>
<p>So, we get some upside (perhaps) from using CPU registers, and some downside with the save/restore of the local registers to/from global registers. To be honest, this mechanism was implemented thinking it would make a huge difference. Truth is, on MS VC with all optimisations, it actually slows the VM down - I guess the swapping loses more than the registers gain. But this may be different on other platforms that are not as savvy - so the implementation is kept. The compile time setting #BVM_USE_REGISTERS is used to turn the usage of the local variable registers on/off.</p>
<p>The number of functions calls made from the interp to other function loop is purposefully kept to a minimum.</p>
<h1><a class="anchor" id="exec-stack"></a>
Stack usage</h1>
<p>For something that does a lot of stack manipulation you may be surprised to see no 'push' or 'pop' functions or macros. All stack access and manipulation within each bytecode impl is relative to the current top of the stack. For example, if the JVMS spec for the byte code says the stack will have an object then an integer and the result should be a (say) float, then the first stack element (the object) will be accessed at SP-2 (SP is 'Stack Pointer'), then the integer at SP-1, the result float will be placed in SP-2 and the current SP decremented by 2 to move the current stack top for the next bytecode.</p>
<p>Perhaps this might seem at first a strange way to go about manipulating a stack - but it is very efficient. The basic premise is that the state of the stack is known at the start and end of each executed bytecode - therefore why bother with excessive pop / push when you know exactly where the bytecode input data is in the stack and exactly where its result (if any) is should be at the end. Simple.</p>
<dl class="section author"><dt>Author</dt><dd>Greg McCreath </dd></dl>
<dl class="section since"><dt>Since</dt><dd>0.0.10 </dd></dl>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a7909a2800d60d4f8ffcddd2923b02c40"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7909a2800d60d4f8ffcddd2923b02c40">&#9670;&nbsp;</a></span>CURRENT_OPCODE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CURRENT_OPCODE&#160;&#160;&#160;(opcode)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a9b71a6eefca1e6c832580bb2d9a9e1cd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9b71a6eefca1e6c832580bb2d9a9e1cd">&#9670;&nbsp;</a></span>OPCODE_DISPATCH</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OPCODE_DISPATCH</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">i</td><td>)</td>
          <td>&#160;&#160;&#160;switch(i) {</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ace6a4a30c3f778ce0b51eb2866230192"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ace6a4a30c3f778ce0b51eb2866230192">&#9670;&nbsp;</a></span>OPCODE_DISPATCH_END</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OPCODE_DISPATCH_END&#160;&#160;&#160;}</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a432e10874d63407a7951d93c57182873"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a432e10874d63407a7951d93c57182873">&#9670;&nbsp;</a></span>OPCODE_HANDLER</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OPCODE_HANDLER</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">n</td><td>)</td>
          <td>&#160;&#160;&#160;case (n)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a275af78a484f8d9913fd113fb4f64966"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a275af78a484f8d9913fd113fb4f64966">&#9670;&nbsp;</a></span>OPCODE_NEXT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OPCODE_NEXT&#160;&#160;&#160;break;</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a75bdaa7be503f9dbdf92f6cb4f5407fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a75bdaa7be503f9dbdf92f6cb4f5407fd">&#9670;&nbsp;</a></span>bvm_exec_run()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bvm_exec_run </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The big execution loop. </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_3b19ecf29356981f494745fbef7e56bf.html">c</a></li><li class="navelem"><a class="el" href="exec_8c.html">exec.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
